<div class="join-container">
  <div class="header">
    <button class="btn-back" (click)="goBack()">← Back</button>
    <h1>Join Game</h1>
  </div>

  @if (connectionStatus() === 'waiting-for-offer') {
    <div class="join-content">
      <p class="instruction">Choose how to receive the host's connection code:</p>

      <div class="method-tabs">
        <button
          class="tab"
          [class.active]="activeMethod() === 'url'"
          (click)="selectMethod('url')"
        >
          URL Link
        </button>
        <button
          class="tab"
          [class.active]="activeMethod() === 'scan'"
          (click)="selectMethod('scan')"
        >
          Scan QR
        </button>
        <button
          class="tab"
          [class.active]="activeMethod() === 'paste'"
          (click)="selectMethod('paste')"
        >
          Paste Code
        </button>
      </div>

      <div class="method-content">
        @if (activeMethod() === 'url') {
          <div class="method-panel">
            <div class="info-box">
              <h3>Using URL Link</h3>
              <p>Click the connection link shared by the host, and you'll automatically join the game.</p>
              <p class="small">The connection data is in the URL after the # symbol.</p>
            </div>
          </div>
        }

        @if (activeMethod() === 'scan') {
          <div class="method-panel">
            <h3>Scan Host's QR Code</h3>
            <app-qr-scanner (scanned)="onOfferScanned($event)" />
          </div>
        }

        @if (activeMethod() === 'paste') {
          <div class="method-panel">
            <h3>Paste Connection Code</h3>
            <textarea
              [value]="pastedCode()"
              (input)="pastedCode.set($any($event.target).value)"
              placeholder="Paste the connection code from the host here..."
              rows="5"
              class="paste-textarea"
            ></textarea>
            <button
              class="btn btn-primary"
              (click)="onPasteSubmit()"
              [disabled]="!pastedCode().trim()"
            >
              Connect
            </button>
          </div>
        }
      </div>
    </div>
  }

  @if (connectionStatus() === 'received-offer' && answerData()) {
    <div class="answer-content">
      <h2>Send This to the Host</h2>
      <p class="instruction">Share this answer with the host so they can complete the connection:</p>
      <app-connection-display [data]="answerData()!" />

      <div class="waiting-message">
        <div class="spinner"></div>
        <p>Waiting for host to accept the connection...</p>
      </div>
    </div>
  }

  @if (connectionStatus() === 'connected') {
    <div class="connected-content">
      <div class="success-box">
        <div class="success-icon">✓</div>
        <h2>Connected!</h2>
        <p>You're now connected to the host.</p>
      </div>

      <div class="test-section">
        <h2>Test Connection</h2>
        <div class="test-controls">
          <input
            type="text"
            [value]="testMessage()"
            (input)="testMessage.set($any($event.target).value)"
            placeholder="Type a test message..."
            class="test-input"
            (keyup.enter)="sendTestMessage()"
          />
          <button class="btn btn-primary" (click)="sendTestMessage()">
            Send to Host
          </button>
        </div>

        @if (messages().length > 0) {
          <div class="messages">
            <h3>Received Messages:</h3>
            <div class="message-list">
              @for (msg of messages(); track msg.timestamp) {
                <div class="message">
                  <span class="message-from">{{ msg.from }}:</span>
                  <span class="message-text">{{ msg.message }}</span>
                  <span class="message-time">{{ msg.timestamp | date:'short' }}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
